<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User Registration</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial; padding:20px; max-width:400px; margin:auto; }
  input, button { padding:10px; margin:5px 0; width:100%; }
  button { background:#2d89ef; color:white; border:none; cursor:pointer; }
  button:hover { background:#1b5fa7; }
  button:disabled { background:#999; cursor:not-allowed; }
  #msg { font-weight:bold; margin-top:10px; }
  #timerContainer { width:100%; height:20px; background:#ddd; margin-top:10px; border-radius:10px; overflow:hidden; }
  #timerBar { width:100%; height:100%; background:#d9534f; transition: width 1s linear; }
  #timerText { font-weight:bold; margin-top:5px; color:#d9534f; text-align:center; }
</style>
</head>
<body>

<h2>User Registration</h2>

<input type="email" id="userEmail" placeholder="Enter email" required>
<input type="password" id="password" placeholder="Password" required>
<input type="password" id="confirmPassword" placeholder="Confirm Password" required>

<button id="getCodeBtn" disabled>Get Verification Code</button>
<button id="resendCodeBtn" disabled>Resend Code</button>

<input type="text" id="verificationCode" placeholder="Enter received code" disabled>
<button id="submitBtn" disabled>Register</button>

<p id="msg"></p>

<div id="timerContainer">
  <div id="timerBar"></div>
</div>
<p id="timerText"></p>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzvPuBw19Zy-f-I8S8rpO4WlHHygHFeWc-MyAKTlEfy5bVTvc2Id31Fu6Yb7dy2KnXW2Q/exec";

const userEmail = document.getElementById("userEmail");
const password = document.getElementById("password");
const confirmPassword = document.getElementById("confirmPassword");
const codeInput = document.getElementById("verificationCode");
const getCodeBtn = document.getElementById("getCodeBtn");
const resendCodeBtn = document.getElementById("resendCodeBtn");
const submitBtn = document.getElementById("submitBtn");
const msg = document.getElementById("msg");
const timerText = document.getElementById("timerText");
const timerBar = document.getElementById("timerBar");

let countdownInterval;
const CODE_DURATION = 2*60;

function showMsg(text,isError=false){ 
  msg.textContent=text; 
  msg.style.color=isError?"red":"green"; 
}

function startTimer() {
  let timeLeft = CODE_DURATION;
  timerBar.style.width = "100%";
  codeInput.disabled=false;
  submitBtn.disabled=false;

  clearInterval(countdownInterval);
  countdownInterval = setInterval(()=>{
    timeLeft--;
    const percent = (timeLeft/CODE_DURATION)*100;
    timerBar.style.width = percent + "%";

    const m = String(Math.floor(timeLeft/60)).padStart(2,'0');
    const s = String(timeLeft%60).padStart(2,'0');
    timerText.textContent = `Time left: ${m}:${s}`;

    if(timeLeft<=0){
      clearInterval(countdownInterval);
      timerText.textContent = "⏰ Code expired. Request new code.";
      codeInput.disabled=true;
      submitBtn.disabled=true;
      resendCodeBtn.disabled=false;
      timerBar.style.width = "0%";
    }
  },1000);
}

// --- CHECK EMAIL ---
userEmail.addEventListener("blur", async () => {
  const email = userEmail.value.trim();
  if(!email) return;
  
  const formData = new URLSearchParams();
  formData.append("action", "checkEmail");
  formData.append("userEmail", email);

  try {
    const res = await fetch(API_URL, { method:"POST", body: formData });
    const text = await res.text();
    if(text.includes("exists")){
      showMsg("⚠️ Email already registered. Contact administrator.", true);
      getCodeBtn.disabled = true;
    } else {
      showMsg("");
      getCodeBtn.disabled = false;
    }
  } catch(err){
    showMsg("⚠️ Error checking email", true);
    getCodeBtn.disabled = true;
  }
});

// --- SEND CODE ---
async function sendCode() {
  if(!userEmail.value || !password.value || !confirmPassword.value){
    showMsg("Fill all fields and password match!", true); return;
  }
  if(password.value !== confirmPassword.value){ showMsg("Passwords do not match!", true); return; }

  showMsg("Sending verification code...");
  getCodeBtn.disabled = true;
  resendCodeBtn.disabled = true;

  const formData = new URLSearchParams();
  formData.append("action", "getCode");
  formData.append("userEmail", userEmail.value);

  try {
    const res = await fetch(API_URL, { method:"POST", body: formData });
    const text = await res.text();
    showMsg(text);

    codeInput.disabled = false;
    submitBtn.disabled = false;
    startTimer();
  } catch(err) {
    showMsg("⚠️ Error sending code", true);
    getCodeBtn.disabled = false;
    resendCodeBtn.disabled = false;
  }
}

getCodeBtn.addEventListener("click", sendCode);
resendCodeBtn.addEventListener("click", sendCode);

// --- FINAL REGISTRATION ---
submitBtn.addEventListener("click", async () => {
  if(!codeInput.value){ showMsg("Enter verification code!", true); return; }

  const formData = new URLSearchParams();
  formData.append("action", "submit");
  formData.append("userEmail", userEmail.value);
  formData.append("password", password.value);
  formData.append("verificationCode", codeInput.value);

  showMsg("Validating code...");
  submitBtn.disabled = true;

  try {
    const res = await fetch(API_URL, { method:"POST", body: formData });
    const text = await res.text();
    if(text.includes("Registration successful")){
      showMsg(text);
      clearInterval(countdownInterval);
      codeInput.disabled = true;
      submitBtn.disabled = true;
      getCodeBtn.disabled = true;
      resendCodeBtn.disabled = true;
      timerBar.style.width="0%";
    } else {
      showMsg(text,true);
      submitBtn.disabled = false;
      codeInput.value="";
    }
  } catch(err){ showMsg("⚠️ Error validating code", true); submitBtn.disabled=false; }
});
</script>
</body>
</html>
